@page "/inventory"

@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.DataGrid
@using MyApp.Web.DTOs.Inventory
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject IJSRuntime Js

<PageTitle>Inventory Management</PageTitle>

<CascadingAuthenticationState>
    <div class="page-header">
        <h2>Inventory</h2>

        <AuthorizeView Roles="User">
            <Authorized>
                <FluentButton Appearance="Appearance.Accent"
                              OnClick="ShowAddDialog"
                              IconStart="@( new Icons.Regular.Size16.Add() )">
                    Add&nbsp;Item
                </FluentButton>
            </Authorized>
        </AuthorizeView>
    </div>

    <FluentDataGrid Items="@_items.AsQueryable()" Sortable Filterable ResizableColumns AutoFit>
        <PropertyColumn Title="ID" Width="50px" Property="@( i => i.Id )"/>
        <PropertyColumn Title="Name" Property="@( i => i.Name )"/>
        <PropertyColumn Title="Quantity" Width="100px" Property="@( i => i.Quantity )"/>

        <TemplateColumn Title="Actions" Width="150px" Context="item">
            <AuthorizeView Roles="Admin,Manager">
                <Authorized>
                    <FluentButton Appearance="Appearance.Stealth"
                                  Title="Edit"
                                  OnClick="@( () => ShowEditDialog(item) )"
                                  IconStart="@( new Icons.Regular.Size16.Edit() )"/>

                    <FluentButton Appearance="Appearance.Stealth"
                                  Title="Delete"
                                  OnClick="@( () => ConfirmDelete(item.Id) )"
                                  IconStart="@( new Icons.Regular.Size16.Delete() )"/>
                </Authorized>
            </AuthorizeView>
        </TemplateColumn>
    </FluentDataGrid>

    <FluentDialog @bind-Hidden="_isDialogHidden">
        <FluentDialogHeader>
            @(_editMode ? "Edit Item" : "Add New Item")
        </FluentDialogHeader>

        <FluentDialogBody>
            <FluentTextField Label="Name"
                             @bind-Value="_currentItem.Name"
                             Placeholder="Enter item name"/>

            <FluentNumberField Label="Quantity"
                               Min="0"
                               @bind-Value="_currentItem.Quantity"/>
        </FluentDialogBody>

        <FluentDialogFooter>
            <FluentButton Appearance="Appearance.Neutral"
                          OnClick="CloseDialog">Cancel
            </FluentButton>

            <FluentButton Appearance="Appearance.Accent"
                          OnClick="SaveItem">
                @(_editMode ? "Update" : "Create")
            </FluentButton>
        </FluentDialogFooter>
    </FluentDialog>
</CascadingAuthenticationState>

@code {
    private List<InventoryItemDto> _items = [ ];
    private InventoryItemDto _currentItem = new();
    private bool _isDialogHidden = true;
    private bool _editMode;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(200); // mock API latency
        _items =
        [
            new InventoryItemDto { Id = 1, Name = "AA Batteries (Pack of 4)", Quantity = 23 },
            new InventoryItemDto { Id = 2, Name = "USB-C Cable", Quantity = 42 },
            new InventoryItemDto { Id = 3, Name = "Wireless Mouse", Quantity = 15 },
        ];
    }

    private void ShowAddDialog()
    {
        _currentItem = new();
        _editMode = false;
        _isDialogHidden = false;
    }

    private void ShowEditDialog( InventoryItemDto item )
    {
        _currentItem = new() { Id = item.Id, Name = item.Name, Quantity = item.Quantity };
        _editMode = true;
        _isDialogHidden = false;
    }

    private void CloseDialog() => _isDialogHidden = true;

    private void SaveItem()
    {
        if ( _editMode )
        {
            var existing = _items.First(i => i.Id == _currentItem.Id);
            existing.Name = _currentItem.Name;
            existing.Quantity = _currentItem.Quantity;
        }
        else
        {
            _currentItem.Id = _items.Any() ? _items.Max(i => i.Id) + 1 : 1;
            _items.Add(_currentItem);
        }

        _isDialogHidden = true;
    }

    private async Task ConfirmDelete( int id )
    {
        if ( await Js.InvokeAsync<bool>("confirm", $"Delete item #{id}?") )
            _items.RemoveAll(i => i.Id == id);
    }

}
